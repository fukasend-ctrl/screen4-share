<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS MOBILE RECEIVER</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #viewer { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        #stream-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        /* YouTube風フローティングUI */
        .ui-layer { position: absolute; inset: 0; pointer-events: none; transition: opacity 0.3s; }
        .ui-layer.fade { opacity: 0; }
        .top-bar { position: absolute; top: 0; width: 100%; padding: 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); color: #fff; font-size: 14px; }
        .bottom-bar { position: absolute; bottom: 0; width: 100%; padding: 30px; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); display: flex; justify-content: flex-end; }
        .control-btn { pointer-events: auto; background: rgba(255,255,255,0.15); border: none; color: #fff; width: 48px; height: 48px; border-radius: 50%; backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 20px; }

        #boot-screen { position: fixed; inset: 0; z-index: 2000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--neon); }
        .start-trigger { background: #00ff41; color: #000; border: none; padding: 18px 45px; border-radius: 35px; font-weight: bold; font-size: 18px; cursor: pointer; box-shadow: 0 0 30px rgba(0,255,65,0.5); }
    </style>
</head>
<body>

<div id="boot-screen">
    <div style="font-size: 24px; font-weight: bold; margin-bottom: 40px; letter-spacing: 4px; color: #00ff41;">NEXUS RECEIVER</div>
    <button class="start-trigger" onclick="NexusMobile.connect()">START MONITORING</button>
</div>

<div id="viewer" onclick="NexusMobile.toggleUI()">
    <img id="stream-img">
    <div class="ui-layer" id="ui-layer">
        <div class="top-bar">● LIVE | 1080P 60FPS</div>
        <div class="bottom-bar">
            <button class="control-btn" onclick="NexusMobile.toggleFS(event)">⛶</button>
        </div>
    </div>
</div>

<script>
    const CLOUD_URL = 'https://circle-sender-chrome-alter.trycloudflare.com';

    const NexusMobile = {
        socket: null,
        img: document.getElementById('stream-img'),
        ui: document.getElementById('ui-layer'),
        uiTimer: null,
        audioCtx: null,

        connect() {
            document.getElementById('boot-screen').style.display = 'none';
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            this.socket = io(CLOUD_URL, { 
                transports: ['websocket'], 
                reconnection: true,
                reconnectionDelay: 500
            });

            this.socket.on('view-data', (data) => {
                this.img.src = data;
            });

            // 音声受信・再生ロジック
            this.socket.on('audio-data', (payload) => {
                this.playAudioChunk(payload.left, payload.right);
            });

            this.autoHideUI();
        },

        playAudioChunk(left, right) {
            if (!this.audioCtx) return;
            const buffer = this.audioCtx.createBuffer(2, left.length, 44100);
            buffer.copyToChannel(new Float32Array(left), 0);
            buffer.copyToChannel(new Float32Array(right), 1);
            const source = this.audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(this.audioCtx.destination);
            source.start();
        },

        toggleUI() {
            this.ui.classList.remove('fade');
            this.autoHideUI();
        },

        autoHideUI() {
            if (this.uiTimer) clearTimeout(this.uiTimer);
            this.uiTimer = setTimeout(() => this.ui.classList.add('fade'), 3000);
        },

        toggleFS(e) {
            e.stopPropagation();
            const el = document.documentElement;
            if (!document.fullscreenElement) {
                if (el.requestFullscreen) el.requestFullscreen();
                else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                screen.orientation.lock('landscape').catch(() => {});
            } else {
                document.exitFullscreen();
            }
        }
    };

    // バックグラウンド復帰時の自動再同期
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && NexusMobile.socket) {
            NexusMobile.socket.connect();
        }
    });
</script>
</body>
</html>
